# v2.5 Reference Code Findings

**Date:** October 20, 2025
**Purpose:** Document existing stocks/futures code from v2.5 for porting to v2.6

---

## Summary

**What We Found:**
✅ Asset definitions for stocks, futures, ETFs
✅ Configuration system for multi-asset trading
✅ Symbol formatting logic for different brokers
✅ Unified trader architecture supporting stocks

❌ **What We Didn't Find:**
- No Alpaca broker implementation (just config reference)
- No actual stock trading broker code
- Futures limited to crypto perpetuals only

**Value:** The asset definitions, configuration structure, and symbol formatting logic are valuable reference material for v2.6 implementation.

---

## Key Files Found

### 1. Asset Factory (`asset_factory.py`)
**Purpose:** Defines tradeable assets and symbol formatting

**Stock Assets Defined:**
```python
STOCK_ASSETS = {
    'AAPL': Asset('AAPL', 'stocks', 'alpaca', 'Apple', 0.001),
    'GOOGL': Asset('GOOGL', 'stocks', 'alpaca', 'Alphabet', 0.001),
    'MSFT': Asset('MSFT', 'stocks', 'alpaca', 'Microsoft', 0.001),
    'TSLA': Asset('TSLA', 'stocks', 'alpaca', 'Tesla', 0.001),
    'AMZN': Asset('AMZN', 'stocks', 'alpaca', 'Amazon', 0.001),
    'META': Asset('META', 'stocks', 'alpaca', 'Meta', 0.001),
    'NVDA': Asset('NVDA', 'stocks', 'alpaca', 'NVIDIA', 0.001),
    'AMD': Asset('AMD', 'stocks', 'alpaca', 'Advanced Micro Devices', 0.001),
    'NFLX': Asset('NFLX', 'stocks', 'alpaca', 'Netflix', 0.001),
    'PYPL': Asset('PYPL', 'stocks', 'alpaca', 'PayPal', 0.001),
}
```

**Futures Assets Defined:**
```python
FUTURES_ASSETS = {
    'BTC_USD_PERP': Asset('BTC_USD_PERP', 'futures', 'bybit', 'Bitcoin Perpetual', 0.001),
    'ETH_USD_PERP': Asset('ETH_USD_PERP', 'futures', 'bybit', 'Ethereum Perpetual', 0.01),
    'SOL_USD_PERP': Asset('SOL_USD_PERP', 'futures', 'bybit', 'Solana Perpetual', 0.1),
    'ADA_USD_PERP': Asset('ADA_USD_PERP', 'futures', 'bybit', 'Cardano Perpetual', 1),
    'DOGE_USD_PERP': Asset('DOGE_USD_PERP', 'futures', 'bybit', 'Dogecoin Perpetual', 1),
}
```

**ETF Assets Defined:**
```python
ETF_ASSETS = {
    'SPY': Asset('SPY', 'etf', 'alpaca', 'S&P 500 ETF', 0.001),
    'QQQ': Asset('QQQ', 'etf', 'alpaca', 'Nasdaq 100 ETF', 0.001),
    'IWM': Asset('IWM', 'etf', 'alpaca', 'Russell 2000 ETF', 0.001),
    'GLD': Asset('GLD', 'etf', 'alpaca', 'Gold ETF', 0.001),
    'TLT': Asset('TLT', 'etf', 'alpaca', 'Treasury ETF', 0.001),
}
```

**Symbol Formatters:**
```python
FORMATTERS = {
    # Crypto
    ('crypto', 'bybit'): lambda s: s,
    ('crypto', 'binance'): lambda s: s,
    ('crypto', 'okx'): lambda s: s.replace('USDT', '-USDT'),
    ('crypto', 'kraken'): lambda s: s.replace('USDT', 'USD'),

    # Stocks
    ('stocks', 'alpaca'): lambda s: s,
    ('stocks', 'interactive'): lambda s: s,

    # Futures
    ('futures', 'bybit'): lambda s: s,
    ('futures', 'binance'): lambda s: s.replace('_USD_PERP', 'USDT'),

    # ETF
    ('etf', 'alpaca'): lambda s: s,
    ('etf', 'interactive'): lambda s: s,
}
```

---

### 2. Alpaca Configuration (`alpaca_stocks_paper_rsi.json`)
**Purpose:** Example configuration for stock trading with Alpaca

```json
{
  "trader_name": "unified_memgpt_trader",
  "version": "2.5.0",
  "description": "Alpaca paper trading stocks with RSI strategy",

  "variants": {
    "broker": "alpaca",
    "strategy": "rsi",
    "mode": "paper",
    "asset_class": "stocks"
  },

  "trading_symbols": {
    "stocks": [
      "AAPL",
      "GOOGL",
      "MSFT",
      "TSLA",
      "NVDA"
    ]
  },

  "broker_config": {
    "active_broker": "alpaca",
    "test_mode": true,
    "credentials": {
      "api_key": "${ALPACA_API_KEY}",
      "api_secret": "${ALPACA_API_SECRET}"
    }
  },

  "risk_settings": {
    "max_position_size": 1000,
    "max_total_exposure": 5000,
    "max_concurrent_positions": 5,
    "default_leverage": 1,
    "risk_per_trade": 0.01
  }
}
```

**Key Insights:**
- Environment variable pattern: `${ALPACA_API_KEY}`
- Risk settings per asset class
- Paper trading mode support
- Leverage = 1 for stocks (no leverage)

---

### 3. Broker Abstraction (`broker_abstraction.py`)
**Purpose:** Interface for all brokers

**Broker Interface:**
```python
class BrokerInterface(ABC):
    @abstractmethod
    async def connect(self) -> bool

    @abstractmethod
    async def get_balance(self) -> float

    @abstractmethod
    async def get_positions(self) -> List[Dict]

    @abstractmethod
    async def place_order(self, symbol: str, side: str, size: float,
                         order_type: str = 'market', price: float = None) -> Dict

    @abstractmethod
    async def close_position(self, symbol: str) -> Dict

    @abstractmethod
    async def get_market_price(self, symbol: str) -> Dict

    @abstractmethod
    async def set_leverage(self, symbol: str, leverage: int) -> bool
```

**Implemented Brokers:**
- ✅ BybitBroker (fully functional - crypto/futures)
- ❌ BinanceBroker (stub only)
- ❌ OKXBroker (stub only)
- ❌ CoinbaseBroker (stub only)
- ❌ KrakenBroker (stub only)
- ❌ **No AlpacaBroker** (referenced in config but not implemented)

---

### 4. Unified Trader (`unified_trader.py`)
**Purpose:** Single configurable trader using variants

**Architecture:**
```python
class UnifiedMemGPTTrader(BaseTrader):
    def __init__(self, config_path: str):
        # Load configuration
        self.variant_loader = VariantLoader(config_path)

        # Extract variants
        broker_name = self.variant_loader.get_broker_name()
        strategy_name = self.variant_loader.get_strategy_name()
        asset_class = self.variant_loader.get_asset_class()

        # Initialize broker
        self.broker = self._initialize_broker(broker_name)

        # Initialize strategy
        self.strategy = self._initialize_strategy(strategy_name)

        # Get symbols
        self.symbols = self.variant_loader.get_symbols(asset_class)
```

**Supported Variants:**
- Brokers: bybit, alpaca, binance, okx, kraken, deribit
- Strategies: momentum, rsi, macd, mfi, vwap
- Modes: live, paper, backtest, futures
- Asset Classes: crypto, stocks, futures, etf

---

### 5. Variant Loader (`variant_loader.py`)
**Purpose:** Load multi-asset configurations

**Key Methods:**
```python
class VariantLoader:
    def get_broker_name(self) -> str
    def get_strategy_name(self) -> str
    def get_mode(self) -> str
    def get_asset_class(self) -> str
    def get_symbols(self, asset_class: str) -> List[str]
    def get_broker_credentials(self) -> Dict
    def get_risk_settings(self) -> Dict
```

**Environment Variable Resolution:**
```python
def get_broker_credentials(self) -> Dict:
    for key, value in credentials.items():
        if value.startswith('${') and value.endswith('}'):
            env_var = value[2:-1]  # Remove ${ and }
            env_value = os.getenv(env_var)
            resolved[key] = env_value or value
```

---

## Porting Strategy to v2.6

### What to Port

1. **Asset Definitions** ✅ (DONE in Phase 1)
   - Ported to `AssetType` enum
   - Symbol list valuable for Phase 2

2. **Symbol Formatting** ✅ (DONE in Phase 1)
   - Ported to `SymbolFormatterService`
   - Enhanced with auto-detection

3. **Configuration Pattern** 🔄 (Can adapt)
   - v2.6 uses `appsettings.json` + environment variables
   - Similar pattern: `${ENV_VAR}` → `builder.Configuration["Key"]`

4. **Risk Settings** 📋 (Phase 6)
   - Port to `RiskManagementService`
   - Asset-class-specific limits

### What NOT to Port

1. ❌ **Alpaca Broker** - Doesn't exist (stub only)
2. ❌ **Python-specific code** - Rewrite in C#
3. ❌ **Variant system** - v2.6 uses DI instead

---

## Lessons Learned

### ✅ Good Patterns from v2.5

1. **Asset class separation** - Clear distinction between crypto/stocks/futures
2. **Symbol formatters** - Broker-specific symbol conversion
3. **Configuration-driven** - Easy to add new assets
4. **Risk settings per asset class** - Different limits for different risk profiles

### 🔄 Improvements in v2.6

1. **Enum-based asset types** - Type-safe vs strings
2. **Dependency injection** - Better than factory pattern
3. **Async/await** - True parallelism (no GIL)
4. **Strong typing** - Compile-time safety

---

## Conclusion

**Findings Summary:**
- ✅ Found valuable asset definitions and symbol formatting logic
- ✅ Found comprehensive configuration pattern
- ✅ Found risk management settings
- ❌ No actual Alpaca broker implementation to port
- ❌ Futures limited to crypto perpetuals only

**Impact on v2.6 Implementation:**
- **Phase 1:** Used asset definitions ✅ COMPLETE
- **Phase 2:** Use stock symbol list from v2.5
- **Phase 3:** Use crypto futures definitions
- **Phase 4-6:** Implement brokers from scratch (no v2.5 reference)

**Next Steps:**
Proceed with Phase 2 using the stock symbols identified in v2.5:
- AAPL, GOOGL, MSFT, TSLA, AMZN, META, NVDA, AMD, NFLX, PYPL
- SPY, QQQ, IWM (ETFs)

---

**Status:** Reference analysis complete
**Usable code:** Asset definitions, symbol formatters, config patterns
**Missing:** Actual broker implementations for stocks
